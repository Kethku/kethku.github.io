<html>
  <head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-139157194-1"></script>
    <script>
     window.dataLayer = window.dataLayer || [];
     function gtag(){dataLayer.push(arguments);}
     gtag('js', new Date());

     gtag('config', 'UA-139157194-1');
    </script>

    <meta name="viewport" content="width=device-width, user-scalable=false">
    <!-- Disable dark reader. Its already dark! --->
    <meta name="darkreader-lock">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <link rel="stylesheet" href="https://kaylees.dev/style.css">
    <link rel="stylesheet" href="https://unpkg.com/basic-css-typography-reset@1.0.0/typography.min.css">
    
    <title>Kaylee's Dev 

Maple
</title>
  </head>
  <body>
    <header>
      <h3>



<a href="https:&#x2F;&#x2F;kaylees.dev&#x2F;">The Trees</a>


<a href="https:&#x2F;&#x2F;kaylees.dev&#x2F;trio&#x2F;">The Fork</a>


<a href="https:&#x2F;&#x2F;kaylees.dev&#x2F;trio&#x2F;maple&#x2F;">Maple</a>

Day9 - Sketchy Text
</h3>
    </header>
    <div id="content">
    
<article>
  <summary>
    
    <h2>
      Partial support for rendering strings of text
    </h2>
    
    
    <p>
    
      2023-04-03
    
    
    </p>
    
  </summary>
  <blockquote>
<p>Scratched into a nearby branch is a scattered and unhinged
rendition of the words &quot;Hello World!&quot;. The text is
misaligned and looks similar to that of a ransom message
cut out of a magazine. Though misshapen and unnerving, the
text is recognizable which represents progress.</p>
</blockquote>
<p>Short day today where I worked on setting up the initial
text shaping with swash. In doing so a couple bugs were
revealed with the text rendering which I plan on
investigating tomorrow.</p>
<p>Text shaping in Neovide is a lot more complicated than would
normally be required because of it's assumption of text on a
grid. Unlike normal text renderers, Neovide doesn't rely on
the font to specify glyph positions. Instead it positions
them manually and only relies on the font to decide which
glyphs to render.</p>
<p>Neovide also uses some lower level features in swash to hook
into the shaping process and fallback to different fonts if
the initial font used didn't have a necessary glyph for the
text at hand.</p>
<p>For this initial test however I went with the simplest setup
which uses swash's add_str to iterate over the text and
shape it all with one font.</p>
<pre data-lang="rs" class="language-rs z-code"><code class="language-rs" data-lang="rs"><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">add_text</span></span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;a</span>, <span class="z-storage z-modifier z-lifetime z-rust">&#39;b</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-modifier z-lifetime z-rust">&#39;a</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span>
    <span class="z-keyword z-operator z-rust">&amp;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;b</span> <span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">self</span>,
    <span class="z-variable z-parameter z-rust">queue</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&amp;</span><span class="z-storage z-modifier z-rust">mut</span> Queue,
    <span class="z-variable z-parameter z-rust">glyph_state</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&amp;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;b</span> <span class="z-storage z-modifier z-rust">mut</span> GlyphState,
    <span class="z-variable z-parameter z-rust">font_ref</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust">FontRef<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;a</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span>,
    <span class="z-variable z-parameter z-rust">text</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&amp;</span><span class="z-storage z-type z-rust">str</span>,
    <span class="z-variable z-parameter z-rust">top_left</span><span class="z-punctuation z-separator z-rust">:</span> Vec2,
    <span class="z-variable z-parameter z-rust">size</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">f32</span>,
    <span class="z-variable z-parameter z-rust">color</span><span class="z-punctuation z-separator z-rust">:</span> Vec4,
</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> shaper <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>context<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">builder</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>font_ref</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">size</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>size</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">build</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>

    shaper<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">add_str</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>text</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>

    <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> current_x <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-constant z-numeric z-float z-rust">0.</span><span class="z-punctuation z-terminator z-rust">;</span>
    shaper<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">shape_with</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">|</span></span></span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-variable z-parameter z-rust">cluster</span><span class="z-punctuation z-section z-parameters z-end z-rust">|</span></span> </span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        <span class="z-keyword z-control z-rust">for</span> glyph <span class="z-keyword z-operator z-rust">in</span> cluster<span class="z-punctuation z-accessor z-dot z-rust">.</span>glyphs <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
            glyph_state<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">add_glyph</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
                queue<span class="z-punctuation z-separator z-rust">,</span>
                font_ref<span class="z-punctuation z-separator z-rust">,</span>
                glyph<span class="z-punctuation z-accessor z-dot z-rust">.</span>id<span class="z-punctuation z-separator z-rust">,</span>
                top_left <span class="z-keyword z-operator z-arithmetic z-rust">+</span> <span class="z-support z-function z-rust">vec2</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>current_x <span class="z-keyword z-operator z-arithmetic z-rust">+</span> glyph<span class="z-punctuation z-accessor z-dot z-rust">.</span>x<span class="z-punctuation z-separator z-rust">,</span> glyph<span class="z-punctuation z-accessor z-dot z-rust">.</span>y</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
                size<span class="z-punctuation z-separator z-rust">,</span>
                color<span class="z-punctuation z-separator z-rust">,</span>
            </span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
            current_x <span class="z-keyword z-operator z-assignment z-rust">+=</span> glyph<span class="z-punctuation z-accessor z-dot z-rust">.</span>advance <span class="z-keyword z-operator z-arithmetic z-rust">+</span> glyph<span class="z-punctuation z-accessor z-dot z-rust">.</span>x<span class="z-punctuation z-terminator z-rust">;</span>
        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>The above code <em>mostly</em> works, but has some problems
revealed by the screen shot:</p>
<p><img src="https://kaylees.dev/trio/maple/day9-sketchy-text/ShapingProblems.png" alt="Shaping Problems" /></p>
<h2 id="vertical-positioning">Vertical Positioning</h2>
<p>The first issue is that the text is rendered as though it is
attached to the top of the window. This is because swash and
most fonts use the baseline of the text as the origin of a
rendered string rather than the top left. In contrast, my
glyph renderer uses the top left. This is a relatively
simple issue to fix.</p>
<h2 id="glyphs-cut-off">Glyphs Cut Off</h2>
<p>The second issue I noticed was that many of the characters
other than the first one are weirdly cut off. The <code>H</code> is
perfect, but all of the other glyphs have a sharp edge on
the right side or in some cases, are rendered completely
incorrectly like the <code>o</code> in &quot;Hello&quot;.</p>
<p>I'm not sure what is causing this problem but it shouldn't
be too difficult to figure out with a combination of
debugging the atlas positions and inspecting the atlas
texture in Renderdoc.</p>
<h2 id="next-steps">Next Steps</h2>
<p>After those two issues are resolved, I would like to think
about the api currently used in Neovide for text shaping
with swash directly and see if I can abstract it's usage
into a simple high level api.</p>
<p>I also recently came across a crate called Cosmic Text which
advertises rust native font fallback and uses swash.
Depending on the license, I may look at adapting that font
fallback code for my renderer in order to check off another
feature we currently depend on Skia for in Neovide.</p>
<p>Till tomorrow,<br />
Kaylee</p>

  
</article>

    </div>
    <!-- <div id="sidebar"> -->
    <!--   <h2>Dynamic Content</h2> -->
    <!--   <p>Some dynamic details to put in the aside</p> -->
    <!-- </div> -->
    <footer>
      
<div id="page-nav-links">
  <h3>
    
    <a href="https:&#x2F;&#x2F;kaylees.dev&#x2F;trio&#x2F;maple&#x2F;day8-glyph-rendering&#x2F;" id="previous-nav">Previous</a>
    

    
    <a href="https:&#x2F;&#x2F;kaylees.dev&#x2F;trio&#x2F;maple&#x2F;day10-perf-improvements&#x2F;" id="next-nav">Next</a>
    
  </h3>
</div>

    </footer>
  </body>
</html>
